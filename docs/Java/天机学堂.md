# 天机学堂

> 一款基于微服务架构的B2C类型的在线教育项目
>

## 一、项目介绍

### 1.1  项目简介

#### 1.1.1 功能架构图

![功能架构图](https://blog-1312463513.cos.ap-shanghai.myqcloud.com/blog/202306122139098.png)

#### 1.1.2 技术架构

#### 1.1.3 业务主题流程

* 后台管理端流程

![后台管理端流程图](https://blog-1312463513.cos.ap-shanghai.myqcloud.com/blog/202306122001158.png)

* 学员端流程

![学员端流程图](https://blog-1312463513.cos.ap-shanghai.myqcloud.com/blog/202306122023740.png)

### 1.2 项目前置开发说明

#### 1.2.1 项目开发流程

1. 需求分析

2. 定义数据模型

3. 定义接口

4. 服务端和前端并行开发

5. 前后端集成测试

#### 1.2.2 项目其他规范

1. 类的领域划分
   * DTO：
数据传输对象，在客户端和服务器之前传递数据
微服务间的Feign接口请求参数
前端提交表单传入封装数据
响应给前端的分页封装数据

   * PO：
持久层对象，与数据库表一一对应，作为查询数据库时的返回值

   * VO：
视图对象，返回给前端用于封装页面展示数据
返回前端

   * QO（Query）
查询对象，一般是用于封装复杂查询条件

1. Git代码规范
   * Git分支规范

     * Master：主分支，用于正式发布的分支

     * Develop：开发分支，从Master创建得来，功能开发的基础分支

     * Feature：功能分支，从Develop唔知创建得来，开发测试完成后会合并到Develop分支

     * Release：预发布分支，从Develop分支创建一个Release分支，做一些发布前的准备工作，不可开发功能，最终合并到Master和Develop

     * Hotfix：热修复分支，当Master出现经济BUG时，基于Master建立的临时分支，修复完后合并到Develop和Master分支

   * Git Commit Type类别说明

     * feat：添加新特性

     * fix：修复bug

     * docs：仅仅修改了文档

     * style：仅仅修改了空格，格式缩进，逗号等等，不改变代码逻辑

     * refactor：代码重构，没有增加新功能或修复bug

     * pref：增加代码进行性能测试

     * test：增加测试用例

     * chore：改变构建流程，或者增加依赖库，工具等

### 1.3 bug解决思路

   1. 抓包

   2. 定位后端服务

   3. 后端代码 Debug 排查错误

## 二、我的课表业务

### 2.1 项目生命周期

1. 市场调研

2. 业务分析

3. 产品设计

4. 项目开发

5. 测试上线

6. 运维

### 2.2 我的课表业务

#### 2.2.1 我的课程需求总结

| 编号  |                    接口简述                     |                                               需求说明                                               |
| :---: | :---------------------------------------------: | :--------------------------------------------------------------------------------------------------: |
|   1   |         支付或报名课程后，立刻加入课表          |   用户对课程支付成功（收费）/直接添加课程（免费）后，交易服务会通知学习服务来执行加入课表的动作。    |
|   2   |                分页查询我的课表                 |                                  分页查询我的课表（已购或已选课程）                                  |
|   3   |            查询我最近正在学习的课程             |                        学员每次学习一个最近课程后，在此页面要显示出此课程数据                        |
|   4   |               删除课表中的某课程                |                       在课程列表中删除课程</br>用户退款，应该删除课表中的课程                        |
|   5   |               查询课程的学习状态                | 不管是收费还是免费的课程，都要显示出用户对此课程状态内容，根据不同的状态，详情也的按钮也会显示不一致 |
|   6   | 校验指定课程是否是课表中的有效课程（Feign接口） |                                  其他业务服务需要的学习中心数据内容                                  |
|   7   |          统计课程学习人数（Feign接口）          |                                                                                                      |

#### 2.2.2 我的课表数据模型

* 规范字段：一般数据模型定义（数据表定义），会遵循与开发规范来定义一些固定的

* 数据属性（表字段）

* 基础字段：根据项目原型来定义数据模型

* 关联字段：业务的数据模型和其他业务关联内容

* 冗余字段：便于查询统计，提高查询效率

### 2.3 分页查询课表

#### 2.3.1 用户userId数据获取

![用户userId数据获取流程图](https://blog-1312463513.cos.ap-shanghai.myqcloud.com/blog/202306172059997.png)

#### 2.3.2 分页查询课表时序图

![分页查询课表时序图](https://blog-1312463513.cos.ap-shanghai.myqcloud.com/blog/202306142342241.png)

### 2.4 添加课表数据

#### 2.4.1 添加课表数据时序图

![添加课表数据时序图](https://blog-1312463513.cos.ap-shanghai.myqcloud.com/blog/202306172104640.png)

上图解释：

1. 用户购买课程调用订单微服务

2. 订单微服务处理订单和支付相关业务后发送异步消息到MQ

3. 学习服务需要查询课程信息，并计算课表的有效时间

4. 学习服务监听器接受到添加个人课表数据消息和课程学习计划

### 2.5 查询最近课表数据

#### 2.5.1 查询最近课表数据时序图

![查询最近课表数据时序图](https://blog-1312463513.cos.ap-shanghai.myqcloud.com/blog/202306150013941.png)

## 三、 学习计划和进度业务

### 3.1 提交学习记录

#### 3.1.1 提交学习记录流程图

![提交学习记录流程图](https://blog-1312463513.cos.ap-shanghai.myqcloud.com/blog/202306172145240.png)

### 3.2 查询学习记录

### 3.3 创建学习计划

### 3.4 查询课程计划

#### 3.4.1 数据来源分析

![查询课程计划](https://blog-1312463513.cos.ap-shanghai.myqcloud.com/blog/202306172150763.png)

![查询课程计划](https://blog-1312463513.cos.ap-shanghai.myqcloud.com/blog/202306172152903.png)

## 四、 课程学习功能优化

### 4.1 课程学习技术要求

#### 4.1.1 视频续播带来的问题

* 后端服务出现高并发的场景

* 后端操作要影响速度快

* 后端数据服务出现大量的写操作

#### 4.1.2 如何解决高并发问题

* 业务层面（开发）
  * 提高单击并发：尽可能减小业务接口的RT（ResultTime），提高单机性能和并发能力

* 数据层面（运维）

  * 水平拓展：将热点服务水平拓展，做好负载均衡，提高整个集群的并发能力

  * 服务保护：做好服务熔断、降级保护措施，提高服务的高可用性

### 4.2 课程学习记录流程优化

#### 4.2.1 视频学习记录优化分析

* 提高单机并发能力思路

  1. 读多写少场景

      * 优化代码和SQL

      * 添加缓存

  2. 写多场景

      * 优化代码和SQL

      * 变同步写为异步写

      * 合并数据库写操作

* 业务优化点

  1. 查询播放记录优化 --读优化
     * 可以使用redis作为缓存，做读优化。redis数据有，直接返回，如果没有再查数据库。

  2. 更新播放记录（学习记录）、更新最近学习小节id、时间（课表） -- 写优化
     * 需要合并数据库请求，只想数据库保存用户最后的播放时间记录。

#### 4.2.2 Redis 优化设计

* redis 数据存储设计
  
![数据存储设计](https://blog-1312463513.cos.ap-shanghai.myqcloud.com/blog/202306180942135.png)

设计说明：

* hash的设计的说明：
  * 大key--用户的课程学习的 课表ID
  * 小key--课程小节id值
  * value值--课程小节对应的学习记录部分数据

#### 4.2.3 合并请求修改数据方式

* 异步定时器更新数据实现

  * 定期来将 redis 中学习记录数据同步到 学习记录 和 课表 中。
      缺陷：

    * 定时任务的持久化方式在播放进度记录业务中存在一些问题，主要就是时效性问题。我们的产品要求视频续播的时间误差不能超过30秒。

    * 假如定时任务间隔较短，例如20秒一次，对数据库的更新频率太高，压力太大

    * 假如定时任务间隔较长，例如2分钟一次，更新频率较低，续播误差可能超过2分钟，不满足需求

* 异步延时更新数据实现

  * 延时更新学习记录同步到 学习记录 和 课表 中。

  * 这里需要将提交视频播放时间和 redis 中最新的时间进行对比

    * 一致：用户不在学习，需要同步到数据库中

    * 不一致：用户还在学习，不需要同步数据库中

#### 4.2.4 延时任务

* 延时任务方案

|      | DelayQueue                          | Redisson                                 | MQ                                   | 时间轮                         |
|------|-------------------------------------|------------------------------------------|--------------------------------------|--------------------------------|
| 原理 | JDK自带延迟队列，基于阻塞队列实现。 | 基于Redis数据结构模拟JDK的DelayQueue实现 | 利用MQ的特性。例如RabbitMQ的死信队列 | 时间轮算法                     |
| 优点 | 不依赖第三方服务                    | 分布式系统下可用 </br>不占用JVM内存      | 分布式系统下可以 </br>不占用JVM内存  | 不依赖第三方服务 </br>性能优异 |
| 缺点 | 占用JVM内存 </br>只能单机使用       | 依赖第三方服务                           | 依赖第三方服务                       | 只能单机使用                   |

#### 4.3 课程学习记录优化实现

* 提交学习记录业务优化流程图

![提交学习记录业务优化流程图](https://blog-1312463513.cos.ap-shanghai.myqcloud.com/blog/202306181026280.png)
