# 05_微服务保护

- Sentinel介绍
    - 雪崩问题及解决方案
        - 什么是雪崩问题？
            - 微服务调用链路中的某个服务故障，引起整个链路中所有微服务都不可用
        - 解决雪崩问题的常见方式：
            - 超时问题：设定超时时间，请求超过一定时间没有响应就返回错误信息，不会无休止等待
            - 舱壁模式：限定每个业务能使用的线程数，避免耗尽整个tomcat的资源，英雌也叫线程隔离
            - 熔断降级：有断路器统计业务执行的异常比例，如果超出阈值则会熔断该业务，拦截访问该业务的一切请求
            - 流量控制：限制业务访问的QPS，避免服务因流量的突增而故障（预防）
    - 服务保护技术对比
        
        
        |  | Sentinel | Hystrix |
        | --- | --- | --- |
        | 隔离策略 | 信号量隔离 | 线程池隔离/信号量隔离 |
        | 熔断降级策略 | 基于慢调用比例或异常比例 | 基于失败比率 |
        | 实时指标实现 | 滑动窗口 | 滑动窗口（基于RxJava） |
        | 规则配置 | 支持多种数据源 | 支持多种数据源 |
        | 拓展性 | 多个拓展点 | 插件形式 |
        | 基于注解的支持 | 支持 | 支持 |
        | 限流 | 基于QPS，支持基于调用关系的限流 | 有限的支持 |
        | 流量整形 | 支持慢启动，匀速排队模式 | 不支持 |
        | 系统自适应保护 | 支持 | 不支持 |
        | 控制台 | 开箱即用，可配置规则，查看秒级监控，机器发现等 | 不完善 |
        | 常见框架适配 | Servlet，Spring，Cloud，Dubbo，gRPC等 | Servlet，Spring，Cloud，Netflix |
    - Sentinel介绍和安装
        
        
        | 配置项 | 默认值 | 说明 |
        | --- | --- | --- |
        | server.port | 8080 | 服务端口 |
        | sentinel.dashboard.auth.username | sentinel | 默认用户名 |
        | sentinel.dashboard.auth.password | sentinel | 默认密码 |
    - 微服务整合Sentinel
        1. 引入sentinel依赖
        2. 配置控制台地址
        3. 访问微服务的任意断电，触发snetinel监控
- 流量控制
    - 流控模式
        - 直接：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式
        - 关联：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流
            
            满足下面条件可以使用关联模式：
            
            - 两个有竞争关系的资源
            - 一个优先级高，一个优先级低，当优先级高的资源触发阈值时对优先级低的做限流
        - 链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流
            - Sentinel默认只标记controller中的方法，如果要标记其他方法，需要利用@SentinelResourece注解
            - Sentinel默认会将Controller方法做context整合，导致链路模式的流控失败，需要修改application.yml，添加配置 web-context-unify:false
    - 流控效果
        - 快速失败：达到阈值时，新的请求会被立即拒绝并抛出FlowException异常（默认处理方式）
        - warm up：预热模式，对超出阈值的请求同样时拒绝并抛出异常，但这种模式阈值会动态变化，从一个较小值逐渐增加到最大阈值
            - 应对服务冷启动的一种方案，请求阈值时初始值是最大阈值（threshold）/冷启动因子（coldFactor，默认为3），持续指定市场后，逐渐增长到threshold值
        - 排队等待：让所有的请求按照先后次序排队执行，两个请求的间隔不能小于指定时长
    - 热点参数限流
        - 分别统计参数值相同的请求，判断是否超过QPS阈值
        - 配置流程：
            - 增加SentinelResource（“hot”）标记注解
            - 配置全局规则
            - 配置例外项规则
- 隔离和降级：对客户端（调用方）的保护
    - FeignClient整合Sentinel
        1. 修改yml文件，开启Feign的Sentinel功能
            
            ```bash
            feign:
            	sentinel:
            		enabled:true  #开启Feign的Sentinel功能
            ```
            
        2. 给FeignClient编写失败后的降级逻辑
            - 方式一：FallbackClass，无法对远程调用的异常做处理
            - 方式二：FallbackFactory，可以对远程调用的异常做处理（常用）
                
                编写一个类实现FallbackFactory接口
                
                ```java
                @Slf4j
                public class UserClientFallbackFactory implements FallbackFactory<UserClient> {
                    @Override
                    public UserClient create(Throwable throwable) {
                        return new UserClient() {
                            @Override
                            public User findById(Long id) {
                                log.error("查询用户异常", throwable);
                                return new User();
                            }
                        };
                    }
                }
                ```
                
        3. 配置降级工厂类到Feign接口
        4. 在Feign接口配置类上添加注解扫描降级工厂类所在的包
    - 线程隔离（舱壁模式）
        
        
        |  | 线程池隔离 | 信号量隔离（Sentinel默认采用） |
        | --- | --- | --- |
        | 优点 | 基于线程池模式，支持主动超时，支持异步调用 | 基于计数器模式，轻量级，无额外开销 |
        | 缺点 | 线程的额外开销比较大 | 不支持主动超市，不支持异步调用 |
        | 场景 | 低扇出，响应时间长 | 高频调用，高扇出，响应时间短 |
    - 熔断降级
        - 由断路器统计服务调用的异常比例，满请求比例，如果超过阈值则会熔断该服务，即拦截访问该服务的一切请求，当服务恢复时，断路器会放行访问该服务的请求
        - 熔断策略
            - 慢调用：业务员响应时长（RT）大于指定时长的请求认定为慢调用，在指定时间内，如果请求数量超过设定的最小数量，慢调用比例大于设定的阈值则触发熔断
            - 异常比例或异常数：统计时间内，如果调用次数超过指定请求次数，并且出现的异常比例或数量到达阈值，则触发熔断
- 授权规则
    - 基本规则
        - 授权规则可以对请求方来源做判断和控制。
        - 授权规则可以对调用方的来源做控制，有白名单和黑名单两种方式。
    - 实现逻辑
        - 通过RequestOriginParser这个接口的parseOrigin来获取请求的来源
        - 默认情况下，sentinel不管请求者从哪里来，返回值永远是default，也就是说一切请求的来源都被认为是一样的值default。因此，我们需要自定义这个接口的实现
    - 修改网关请求头
        - 修改gateway服务中的application.yml，添加一个defaultFilter
            
            ```bash
            spring:
              cloud:
                gateway:
                  default-filters:
                    - AddRequestHeader=origin,gateway
            ```
            
    - 自定义异常
        - 实现BlockExceptionHandler接口
            
            ```bash
            public interface BlockExceptionHandler {
                void handle(HttpServletRequest request, HttpServletResponse response, BlockException e) throws Exception;
            }
            ```
            
        - BlockExceptionHandler的子类
            
            
            | 异常 | 说明 |
            | --- | --- |
            | FlowException | 限流异常 |
            | ParamFlowException | 热点参数限流的异常 |
            | DegradeException | 降级异常 |
            | AuthorityException | 授权规则异常 |
            | SystemBlockException | 系统规则异常 |
- 规则持久化
    - 规则管理模式
        - 原始模式：默认模式，重启失效
        - pull：控制台将配置的规则推送到Sentinel客户端，客户端会将配置规则保存到本地文件或数据库中，之后会定时查询本地文件或者数据库，更新本地规则，存在时效性问题
        - push：控制台将配置规则推送到远程配置中心（Nacos）Sentinel客户端监听Nacos，获取配置变更的推送消息，完成本地配置的更新